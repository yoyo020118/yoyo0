<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { color: #333; }
        input { padding: 10px; width: 70%; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #218838; }
        .user-card, .request-card { border: 1px solid #ddd; padding: 10px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
        .btn-add { background: #007bff; }
        .btn-accept { background: #28a745; }
        .section { margin-top: 30px; text-align: right; }
        .hidden { display: none; }
        #status { color: red; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div id="loginScreen">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <input type="text" id="usernameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§...">
            <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="appScreen" class="hidden">
            <h3 id="welcomeMsg"></h3>
            
            <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø© -->
            <div class="section">
                <h4>ğŸ”” Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø©:</h4>
                <div id="requestsList">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ -->
            <div class="section">
                <h4>âœ… Ø£ØµØ¯Ù‚Ø§Ø¤Ùƒ:</h4>
                <div id="friendsList">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</div>
            </div>

            <!-- ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
            <div class="section">
                <h4>ğŸ‘¥ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¢Ø®Ø±ÙˆÙ† (Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†):</h4>
                <div id="allUsersList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>
        <p id="status"></p>
    </div>

    <!-- Ø±Ø¨Ø· Firebase -->
    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù…Ù† Ù…ÙƒØªØ¨Ø© ÙØ§ÙŠØ±Ø¨ÙŠØ³
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, child, get } 
        from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        // -----------------------------------------------------------
        // âš ï¸âš ï¸ Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø£Ø¯Ù†Ø§Ù‡ âš ï¸âš ï¸
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDxxxxxxxxx-xxxxxxxx",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:xxxxxx"
        };
        // -----------------------------------------------------------

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let myId = localStorage.getItem('myUserId');
        let myName = localStorage.getItem('myUserName');

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.login = function() {
            const nameInput = document.getElementById('usernameInput').value;
            if (!nameInput) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");

            // Ø¥Ù†Ø´Ø§Ø¡ ID Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!myId) {
                myId = 'user_' + Date.now();
                localStorage.setItem('myUserId', myId);
            }
            myName = nameInput;
            localStorage.setItem('myUserName', myName);

            // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            set(ref(db, 'users/' + myId), {
                username: myName,
                id: myId,
                status: 'online'
            }).then(() => {
                showApp();
            });
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ¥Ø®ÙØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('welcomeMsg').innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${myName}`;
            
            loadUsers();
            loadRequests();
            loadFriends();
        }

        // 1. ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (LIVE)
        function loadUsers() {
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snapshot) => {
                const usersListDiv = document.getElementById('allUsersList');
                usersListDiv.innerHTML = "";
                const data = snapshot.val();

                if (data) {
                    Object.values(data).forEach(user => {
                        // Ù„Ø§ ØªØ¹Ø±Ø¶ Ù†ÙØ³Ùƒ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                        if (user.id !== myId) {
                            // ØªØ­Ù‚Ù‚ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ØµØ¯ÙŠÙ‚Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
                            get(ref(db, `friends/${myId}/${user.id}`)).then((friendSnap) => {
                                if(!friendSnap.exists()) {
                                    const div = document.createElement('div');
                                    div.className = 'user-card';
                                    div.innerHTML = `
                                        <span>ğŸ‘¤ ${user.username}</span>
                                        <button class="btn-add" onclick="sendRequest('${user.id}', '${user.username}')">Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</button>
                                    `;
                                    usersListDiv.appendChild(div);
                                }
                            });
                        }
                    });
                } else {
                    usersListDiv.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¢Ø®Ø±ÙŠÙ†.";
                }
            });
        }

        // 2. Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©
        window.sendRequest = function(targetId, targetName) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ø¯Ù‰ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø±
            // Ø§Ù„Ù…Ø³Ø§Ø±: requests -> TargetID -> MyID
            set(ref(db, `requests/${targetId}/${myId}`), {
                fromName: myName,
                fromId: myId
            }).then(() => {
                alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ${targetName}`);
            }).catch(err => console.error(err));
        }

        // 3. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (LIVE)
        function loadRequests() {
            const requestsRef = ref(db, `requests/${myId}`);
            onValue(requestsRef, (snapshot) => {
                const list = document.getElementById('requestsList');
                list.innerHTML = "";
                const data = snapshot.val();

                if (data) {
                    Object.values(data).forEach(req => {
                        const div = document.createElement('div');
                        div.className = 'request-card';
                        div.style.borderColor = "#ffc107";
                        div.innerHTML = `
                            <span>ğŸ“© Ø·Ù„Ø¨ Ù…Ù†: <b>${req.fromName}</b></span>
                            <button class="btn-accept" onclick="acceptRequest('${req.fromId}', '${req.fromName}')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                        `;
                        list.appendChild(div);
                    });
                } else {
                    list.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.";
                }
            });
        }

        // 4. Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
        window.acceptRequest = function(friendId, friendName) {
            // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø®Øµ Ù„Ù‚Ø§Ø¦Ù…ØªÙŠ
            const updates = {};
            updates[`friends/${myId}/${friendId}`] = { name: friendName };
            // 2. Ø¥Ø¶Ø§ÙØªÙŠ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø±
            updates[`friends/${friendId}/${myId}`] = { name: myName };
            // 3. Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
            updates[`requests/${myId}/${friendId}`] = null;

            update(ref(db), updates).then(() => {
                alert("ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©! Ø£ØµØ¨Ø­ØªÙ…Ø§ Ø£ØµØ¯Ù‚Ø§Ø¡.");
            });
        }

        // 5. ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ (LIVE)
        function loadFriends() {
            const friendsRef = ref(db, `friends/${myId}`);
            onValue(friendsRef, (snapshot) => {
                const list = document.getElementById('friendsList');
                list.innerHTML = "";
                const data = snapshot.val();

                if (data) {
                    Object.values(data).forEach(friend => {
                        const div = document.createElement('div');
                        div.className = 'user-card';
                        div.style.backgroundColor = "#e8f5e9";
                        div.innerHTML = `<span>âœ… ${friend.name}</span>`;
                        list.appendChild(div);
                    });
                }
            });
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ø³Ø§Ø¨Ù‚Ø©
        if(myId && myName) {
            showApp();
        }
    </script>
</body>
</html>
